<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing FMS - Sales & Accounts Stages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
        }
        /* Entrance Animation Styles */
        #entranceAnimationOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); /* For Safari */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999; 
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        #entranceAnimationOverlay.hidden {
            opacity: 0;
            pointer-events: none; 
        }
        /* CSS Spinner */
        .spinner {
            width: 60px; 
            height: 60px;
            border: 6px solid rgba(79, 70, 229, 0.3); 
            border-top-color: #4f46e5; 
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            margin-top: 1.5rem; 
            font-size: 1.25rem; 
            font-weight: 600; 
            color: #374151; 
            animation: fadeInOut 2s infinite ease-in-out;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Modal Popup Animation */
        @keyframes modalPopup {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            60% { /* Overshoot point */
                transform: scale(1.05);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        /* Corrected CSS selector: Apply animation when .modal-popup-active is ON .modal-content */
        .modal-content.modal-popup-active { 
            animation: modalPopup 0.4s ease-out forwards;
        }


        .modal {
            display: none; position: fixed; z-index: 1000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            overflow: auto; background-color: rgba(0,0,0,0.5); 
        }
        .modal-content-wrapper {
            display: flex; align-items: center; justify-content: center;
            min-height: 100%; padding: 1rem; 
        }
        .modal-content {
            background-color: #ffffff; margin: auto; padding: 25px; 
            border: 1px solid #d1d5db; width: 90%; 
            border-radius: 0.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            position: relative; 
            transform: scale(1); 
            opacity: 1;
        }
        #addEntrySectionModal .modal-content, 
        #entryDetailsModal .modal-content,
        #howToUseModal .modal-content { 
            max-width: 850px; 
            max-height: 90vh; overflow-y: auto; 
        }
        #doerInfoModal .modal-content { max-width: 700px; max-height: 85vh; overflow-y: auto; }
        #messageAlertModal .modal-content { max-width: 450px; }

        .close-button { 
            color: #6b7280; position: absolute; top: 10px; right: 15px;
            font-size: 30px; font-weight: bold; transition: color 0.2s;
            line-height: 1; 
        }
        .close-button:hover, .close-button:focus { color: #1f2937; text-decoration: none; cursor: pointer; }

        .modal-controls-group { 
            position: absolute;
            top: 12px; 
            right: 15px;
            display: flex;
            align-items: center;
            gap: 6px; 
            z-index: 10; 
        }
        .modal-control-button {
            background: none;
            border: none;
            padding: 4px; 
            cursor: pointer;
            line-height: 1;
            display: flex; 
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem; 
            transition: background-color 0.2s;
        }
        .modal-control-button svg {
            width: 16px; 
            height: 16px;
            display: block; 
        }
        .modal-control-button.delete-btn svg { fill: #9ca3af; }
        .modal-control-button.delete-btn:hover svg { fill: #dc2626; }
        .modal-control-button.close-btn svg { fill: #9ca3af; }
        .modal-control-button.close-btn:hover svg { fill: #374151; }
         .modal-control-button.close-lost-btn svg { fill: #9ca3af; }
        .modal-control-button.close-lost-btn:hover svg { fill: #f97316; } 
        .modal-control-button:hover { background-color: #e5e7eb; }

        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 500; 
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, transform 0.1s ease;
            cursor: pointer; text-align: center; display: inline-flex; 
            align-items: center; justify-content: center;
        }
        .btn svg { margin-right: 0.5rem; margin-left: -0.25rem; }
        .btn-icon-only svg { margin-right: 0; margin-left: 0; } 
        .btn:active { transform: translateY(1px); }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; box-shadow: 0 4px 14px 0 rgba(79,70,229,0.39); }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-success { background-color: #10b981; color: white; } 
        .btn-success:hover { background-color: #059669; }
        .btn-warning { background-color: #f59e0b; color: white; } 
        .btn-warning:hover { background-color: #d97706; }
        .btn-info { background-color: #3b82f6; color: white; } 
        .btn-info:hover { background-color: #2563eb; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        
        .form-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 1rem; }
        @media (min-width: 768px) { 
            .form-grid { grid-template-columns: repeat(2, 1fr); gap: 1.25rem; }
            .form-grid .col-span-2 { grid-column: span 2 / span 2; }
        }
        .checkbox-group label { margin-right: 1rem; display: inline-flex; align-items: center; }
        .checkbox-group input[type="checkbox"] { margin-right: 0.25rem; }

        .delay-ontime { color: #10b981; font-weight: 500; }
        .delay-late { color: #dc2626; font-weight: 500; }
        .delay-early { color: #3b82f6; font-weight: 500; }
        .overdue-task { color: #dc2626; font-weight: bold; } 

        #entryDetailsModal .crm-card { background: #fff; }
        #entryDetailsModal .crm-card h2 { margin-bottom: 16px; font-size: 1.25rem; color: #2c3e50; font-weight: 600; }
        #entryDetailsModal .crm-section-row { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        #entryDetailsModal .crm-section { flex: 1 1 300px; border-radius: 8px; border: 1px solid #e0e0e0; background-color: var(--section-bg, rgba(200,200,200,0.1)); font-size: 13px; min-width: 280px; }
        #entryDetailsModal .crm-section-header { padding: 8px 12px; font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 8px; color: white; background-color: var(--section-color, #777); border-top-left-radius: 7px; border-top-right-radius: 7px;}
        #entryDetailsModal .crm-section-header svg { width: 16px; height: 16px; fill: white;}
        #entryDetailsModal .crm-section-content { padding: 10px 12px; border-bottom-left-radius: 7px; border-bottom-right-radius: 7px;}
        #entryDetailsModal .crm-description-item { margin-bottom: 8px; }
        #entryDetailsModal .crm-description-item:last-child { margin-bottom: 0; }
        #entryDetailsModal .crm-label { font-weight: 600; color: #555; font-size: 0.8rem; margin-bottom: 2px;}
        #entryDetailsModal .crm-value { font-size: 0.9rem; color: #222; word-break: break-word;}
        #entryDetailsModal .crm-status-banner { background-color: #fff3cd; color: #856404; padding: 10px 12px; border-radius: 8px; font-weight: 700; text-align: center; margin-top: 20px; font-size: 14px;}

        .details-section { background-color: #f9fafb; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1.25rem; border: 1px solid #e5e7eb;}
        .details-section h3 { font-size: 1.125rem; font-weight: 600; color: #4f46e5; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid #6366f1; }
        .timeline-step { padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; margin-bottom: 0.75rem; background-color: #fff;}
        .timeline-step strong { color: #4338ca; font-size: 1rem; display: block; margin-bottom: 0.25rem;}
        .timeline-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;}
        .timeline-details-grid .details-item { padding: 0.1rem 0; margin-bottom: 0.1rem;}
        .timeline-details-grid .details-label { font-size: 0.8rem; }
        .timeline-details-grid .details-value { font-size: 0.85rem; }
        .timeline-step .btn-take-action { margin-top: 0.75rem; padding: 0.375rem 0.75rem; font-size: 0.875rem; }

        .sortable-header { cursor: pointer; position: relative; padding-right: 20px; }
        .sortable-header::after { content: ''; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 0.8em; opacity: 0.5;}
        .sortable-header.sort-asc::after { content: '▲'; opacity: 1; }
        .sortable-header.sort-desc::after { content: '▼'; opacity: 1; }

        .scorecard-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;}
        .scorecard { background-color: white; padding: 1.25rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); text-align: center;}
        .scorecard-title { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500; }
        .scorecard-value { font-size: 2.25rem; font-weight: 700; color: #1f2937; }
        .scorecard.total-entries .scorecard-value { color: #4f46e5; }
        .scorecard.pending-confirmation .scorecard-value { color: #f59e0b; }
        .scorecard.awaiting-bill-prep .scorecard-value { color: #84cc16; }
        .scorecard.invoice-generated .scorecard-value { color: #3b82f6; }
        .scorecard.payment-followup .scorecard-value { color: #a855f7; }
        .scorecard.payment-completed .scorecard-value { color: #10b981; }

        /* Distinct Status Badge Styles */
        .status-badge {
            padding: 0.25em 0.6em;
            border-radius: 0.25rem; 
            font-size: 0.75rem; 
            font-weight: 500; 
            text-align: center;
            display: inline-block;
            min-width: 120px; 
            color: white; 
        }
        .status-entry-added-awaiting-customer-confirmation { background-color: #fbbf24; color: #78350f; }
        .status-customer-confirmed-awaiting-bill-prep { background-color: #a3e635; color: #3f6212; }
        .status-bill-prepared-awaiting-invoice-generation { background-color: #67e8f9; color: #155e75; }
        .status-invoice-generated-awaiting-bill-receiving-followup { background-color: #60a5fa; color: #1e3a8a; }
        .status-bill-followed-up-awaiting-payment-followup { background-color: #818cf8; color: #3730a3; }
        .status-payment-followed-up-awaiting-payment-receive { background-color: #c084fc; color: #581c87; }
        .status-payment-received-awaiting-next-action { background-color: #34d399; color: #065f46; }
        .status-due-followed-up-awaiting-payment-arrangement { background-color: #f472b6; color: #831843; }
        .status-payment-arrangement-made-awaiting-payment-completion { background-color: #fb7185; color: #881337; }
        .status-payment-completed { background-color: #14b8a6; color: white;}
        .status-closed-lost { background-color: #ef4444; color: white; }
        .status-default { background-color: #9ca3af; color: white; }

        /* Class for rotating sync icon */
        .rotate-animate {
            animation: rotateIcon 1s linear;
        }
        @keyframes rotateIcon {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .main-content-area {
            flex-grow: 1; 
        }


        @media screen and (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; margin-bottom: 0.625em; border-radius: 0.375rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); border: 1px solid #e5e7eb;}
            .responsive-table td { display: block; text-align: right; font-size: 0.875rem; border-bottom: 1px solid #e5e7eb; padding-left: 50% !important; position: relative;}
            .responsive-table td::before { content: attr(data-label); position: absolute; left: 0.75rem; width: 45%; padding-right: 0.75rem; white-space: nowrap; text-align: left; font-weight: 600; color: #4b5563; }
            .responsive-table td:last-child { border-bottom: 0; }
            .responsive-table.doer-info-table td { padding-left: 30% !important; } 
            .responsive-table.doer-info-table td::before { width: 25%; } 
            .main-action-buttons button { width: 100%; margin-bottom: 0.5rem;} 
            .scorecard-container { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));} 
        }
    </style>
</head>
<body class="bg-gray-100"> 

    <div id="entranceAnimationOverlay">
        <div class="spinner"></div> 
        <p class="loading-text">Loading Billing FMS...</p> 
    </div>

    <header class="sticky top-0 z-50 bg-white shadow-md">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5M12 15.75h.008v.008H12v-.008z" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-lg font-bold text-gray-800">Billing FMS</p> 
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="hidden sm:block">
                        <p id="dateTimeDisplay" class="text-xs text-gray-500"></p>
                    </div>

                    <button id="syncButton" type="button" title="Sync Data" class="p-1.5 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        <span class="sr-only">Sync Data</span>
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                    </button>

                    <button type="button" title="User Profile" class="p-1.5 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        <span class="sr-only">Open user menu</span>
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="main-content-area container mx-auto max-w-7xl bg-white p-6 md:p-8 rounded-lg shadow-xl mt-4 md:mt-6 lg:mt-8"> 
        <div class="mb-6 flex flex-wrap justify-end gap-2 main-action-buttons"> 
            <button id="openDoerInfoModalButton" class="btn btn-secondary text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-lines-fill" viewBox="0 0 16 16"><path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5m.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1zm0 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1zm0 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1z"/></svg>
                Responsibilities
            </button>
            <button id="openHowToUseModalButton" class="btn btn-secondary text-sm"> 
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-question-circle-fill" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M5.496 6.033h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286a.237.237 0 0 0 .241.247zm2.325 6.443c-.584 0-1.009-.394-1.009-.927 0-.552.425-.94 1.01-.94.609 0 1.028.388 1.028.94 0 .533-.42.927-1.029.927z"/>
                </svg>
                How to Use
            </button>
            <button id="openEntryFormModalButton" class="btn btn-primary text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/></svg>
                Add Entry
            </button>
        </div>

        <section id="scorecardSection" class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Overview Scorecards</h2>
            <div class="scorecard-container">
                <div class="scorecard total-entries">
                    <div class="scorecard-title">Total Bills</div>
                    <div class="scorecard-value" id="scorecardTotalEntries">0</div>
                </div>
                <div class="scorecard pending-confirmation">
                    <div class="scorecard-title">Pending Confirmation</div>
                    <div class="scorecard-value" id="scorecardPendingConfirmation">0</div>
                </div>
                <div class="scorecard awaiting-bill-prep">
                    <div class="scorecard-title">Awaiting Bill Prep</div>
                    <div class="scorecard-value" id="scorecardAwaitingBillPrep">0</div>
                </div>
                <div class="scorecard invoice-generated">
                    <div class="scorecard-title">Invoice Generated</div>
                    <div class="scorecard-value" id="scorecardInvoiceGenerated">0</div>
                </div>
                 <div class="scorecard payment-followup">
                    <div class="scorecard-title">Payment Followup</div>
                    <div class="scorecard-value" id="scorecardPaymentFollowup">0</div>
                </div>
                <div class="scorecard payment-completed">
                    <div class="scorecard-title">Payment Completed</div>
                    <div class="scorecard-value" id="scorecardPaymentCompleted">0</div>
                </div>
            </div>
        </section>


        <div id="addEntrySectionModal" class="modal"><div class="modal-content-wrapper">
            <section class="modal-content bg-gray-50"><span id="closeEntryFormModalButton" class="close-button">&times;</span>
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Add New Billing Entry</h2>
                <form id="billingEntryForm" class="space-y-4">
                    <div class="form-grid">
                        <div><label for="entryTimestamp" class="block text-sm font-medium text-gray-700 mb-1">Timestamp (Actual for Step 1)</label><input type="datetime-local" id="entryTimestamp" name="entryTimestamp" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div><label for="uid" class="block text-sm font-medium text-gray-700 mb-1">Unique ID (UID)</label><input type="text" id="uid" name="uid" readonly class="w-full p-3 border border-gray-300 rounded-md shadow-sm bg-gray-100 focus:outline-none"></div>
                        <div class="col-span-2"><label for="billingName" class="block text-sm font-medium text-gray-700 mb-1">Billing Name</label><input type="text" id="billingName" name="billingName" placeholder="Enter client or company name" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div class="col-span-2"><label for="billingAddress" class="block text-sm font-medium text-gray-700 mb-1">Billing Address</label><textarea id="billingAddress" name="billingAddress" rows="3" placeholder="Enter full billing address" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea></div>
                        <div><label for="emailId" class="block text-sm font-medium text-gray-700 mb-1">Email ID</label><input type="email" id="emailId" name="emailId" placeholder="client@example.com" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div><label for="mobileNumber" class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label><input type="tel" id="mobileNumber" name="mobileNumber" placeholder="+91 XXXXXXXXXX" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div><label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label><select id="category" name="category" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option value="">Select Category</option> <option value="Commercial">Commercial</option> <option value="Land/Plot">Land/Plot</option> <option value="Residential">Residential</option> <option value="ROI Property">ROI Property</option> <option value="Warehouse">Warehouse</option></select></div>
                        <div class="col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">Requirement</label><div id="requirement" class="checkbox-group mt-1 p-3 border border-gray-300 rounded-md bg-white"><label><input type="checkbox" name="requirement_buy" value="Buy"> Buy</label><label><input type="checkbox" name="requirement_lease" value="Lease"> Lease</label><label><input type="checkbox" name="requirement_rent" value="Rent"> Rent</label></div><p id="requirementError" class="text-xs text-red-500 mt-1 hidden">Please select at least one requirement.</p></div>
                        <div><label for="gstBill" class="block text-sm font-medium text-gray-700 mb-1">GST or Non-GST Bill</label><select id="gstBill" name="gstBill" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option value="">Select Bill Type</option> <option value="GST Bill">GST Bill</option> <option value="Non-GST Bill">Non-GST Bill</option></select></div>
                        <div><label for="gstNumber" class="block text-sm font-medium text-gray-700 mb-1">GST # (If applicable)</label><input type="text" id="gstNumber" name="gstNumber" placeholder="e.g., 22AAAAA0000A1Z5" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div><label for="commissionTenure" class="block text-sm font-medium text-gray-700 mb-1">Commission Tenure (Years)</label><input type="number" id="commissionTenure" name="commissionTenure" placeholder="e.g., 1" min="0" step="1" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div><label for="taxableValue" class="block text-sm font-medium text-gray-700 mb-1">Taxable Value (₹)</label><input type="number" id="taxableValue" name="taxableValue" placeholder="0.00" step="0.01" min="0" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                        <div class="col-span-2"><label for="assignedBy" class="block text-sm font-medium text-gray-700 mb-1">Assigned By</label><select id="assignedBy" name="assignedBy" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option value="">Select Assigner</option> <option value="Basant Agarwal">Basant Agarwal</option> <option value="Dipesh Chandra Pradhan">Dipesh Chandra Pradhan</option> <option value="Parshuram Jha">Parshuram Jha</option> <option value="Rajesh Kumar Thakur">Rajesh Kumar Thakur</option> <option value="Sanat Majumdar">Sanat Majumdar</option> <option value="Sayantun Paul">Sayantun Paul</option> <option value="Sumit Sha">Sumit Sha</option></select></div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4"><button type="button" id="clearFormButton" class="btn btn-secondary">Clear Form</button><button type="submit" id="submitButton" class="btn btn-primary">Add Entry <span id="loadingSpinner" class="hidden ml-2 inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span></button></div>
                </form>
            </section>
        </div></div>

        <div id="doerInfoModal" class="modal"><div class="modal-content-wrapper">
            <section class="modal-content bg-white"><span id="closeDoerInfoModalButton" class="close-button">&times;</span>
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">Billing Process Responsibilities</h2>
                <div class="table-container overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 responsive-table doer-info-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task / Stage (What)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doer Name</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td data-label="Icon" class="px-3 py-4 text-center">
                                    <svg class="h-6 w-6 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                                </td>
                                <td data-label="Task / Stage" class="px-6 py-4 whitespace-nowrap">Detail Provide</td>
                                <td data-label="Doer Name" class="px-6 py-4 whitespace-nowrap">Sales Coordinator</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td data-label="Icon" class="px-3 py-4 text-center">
                                    <svg class="h-6 w-6 text-green-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </td>
                                <td data-label="Task / Stage" class="px-6 py-4 whitespace-nowrap">Confirmation from Customer</td>
                                <td data-label="Doer Name" class="px-6 py-4 whitespace-nowrap">Accounts</td>
                            </tr>
                            <tr>
                                <td data-label="Icon" class="px-3 py-4 text-center">
                                    <svg class="h-6 w-6 text-yellow-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                                </td>
                                <td data-label="Task / Stage" class="px-6 py-4 whitespace-nowrap">Bill Preparation</td>
                                <td data-label="Doer Name" class="px-6 py-4 whitespace-nowrap">Accounts</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td data-label="Icon" class="px-3 py-4 text-center">
                                     <svg class="h-6 w-6 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227l-2.291-.682c-.362-.107-.706-.248-1.02-.414m1.02.414c-.314-.166-.626-.348-.924-.548m0 0l-.229-2.523m0 0a31.005 31.005 0 00-4.5-.26V21m0 0a31.003 31.003 0 00-4.5.26v-2.735m0 0c-.298.2-.61.381-.924.548m0 0l-.229 2.523a1.125 1.125 0 01-1.12-1.227L6.34 18m0 0l-2.06-2.06C3.902 15.58 3 14.055 3 12.372V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v5.622c0 1.683-.902 3.208-2.28 3.788Z" /></svg>
                                </td>
                                <td data-label="Task / Stage" class="px-6 py-4 whitespace-nowrap">Invoice Generation</td>
                                <td data-label="Doer Name" class="px-6 py-4 whitespace-nowrap">Accounts</td>
                            </tr>
                            <tr>
                                <td data-label="Icon" class="px-3 py-4 text-center">
                                    <svg class="h-6 w-6 text-purple-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 13.5h3.86a2.25 2.25 0 012.012 1.244l.256.512a2.25 2.25 0 002.013 1.244h3.218a2.25 2.25 0 002.013-1.244l.256-.512a2.25 2.25 0 012.013-1.244h3.859m-19.5.338V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338a2.25 2.25 0 00-2.12-1.58H6.88a2.25 2.25 0 00-2.12 1.58L2.35 13.177a2.25 2.25 0 00-.1.661z" /></svg>
                                </td>
                                <td data-label="Task / Stage" class="px-6 py-4 whitespace-nowrap">Bill Receiving Followup</td>
                                <td data-label="Doer Name" class="px-6 py-4 whitespace-nowrap">Accounts / CRM</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td data-label="Icon" class="px-3 py-4 text-center">
                                    <svg class="h-6 w-6 text-pink-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" /></svg>
                                </td>
                                <td data-label="Task / Stage" class="px-6 py-4 whitespace-nowrap">Payment Followup</td>
                                <td data-label="Doer Name" class="px-6 py-4 whitespace-nowrap">Accounts / CRM</td>
                            </tr>
                            <tr>
                                <td data-label="Icon" class="px-3 py-4 text-center">
                                    <svg class="h-6 w-6 text-emerald-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75-.75v-.75M6 13.5V12m6.75 1.5V12" /></svg>
                                </td>
                                <td data-label="Task / Stage" class="px-6 py-4 whitespace-nowrap">Payment Receive</td>
                                <td data-label="Doer Name" class="px-6 py-4 whitespace-nowrap">Accounts / CRM</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td data-label="Icon" class="px-3 py-4 text-center">
                                    <svg class="h-6 w-6 text-red-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-3.75h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z" /></svg>
                                </td>
                                <td data-label="Task / Stage" class="px-6 py-4 whitespace-nowrap">Due Followup</td>
                                <td data-label="Doer Name" class="px-6 py-4 whitespace-nowrap">Accounts / CRM</td>
                            </tr>
                            <tr>
                                <td data-label="Icon" class="px-3 py-4 text-center">
                                    <svg class="h-6 w-6 text-orange-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-3.741-3.741M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 8.25V12m0 3.75V12M12 12h3.75M12 12H8.25" /></svg>
                                </td>
                                <td data-label="Task / Stage" class="px-6 py-4 whitespace-nowrap">Payment Arrangement</td>
                                <td data-label="Doer Name" class="px-6 py-4 whitespace-nowrap">Assigned Sale Person</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td data-label="Icon" class="px-3 py-4 text-center">
                                    <svg class="h-6 w-6 text-green-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
                                </td>
                                <td data-label="Task / Stage" class="px-6 py-4 whitespace-nowrap">Payment Completion</td>
                                <td data-label="Doer Name" class="px-6 py-4 whitespace-nowrap">Accounts / CRM</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div></div>
        
        <div id="entryDetailsModal" class="modal"><div class="modal-content-wrapper">
            <section class="modal-content bg-white">
                <h2 class="text-2xl font-semibold text-gray-700 mb-1 mt-8" id="detailsModalTitle">Entry Details</h2> 
                <p class="text-sm text-gray-500 mb-6" id="detailsModalSubtitle"></p>
                <div id="detailsModalContent">
                    </div>
            </section>
        </div></div>

        <div id="howToUseModal" class="modal"><div class="modal-content-wrapper">
            <section class="modal-content bg-white">
                <span id="closeHowToUseModalButton" class="close-button">&times;</span>
                <h1 class="text-2xl font-bold text-indigo-600 mb-4">How to Use the Billing FMS</h1>
                <div class="space-y-4 text-gray-700 text-sm leading-relaxed">
                    <p>Welcome to the <strong>Billing Follow-up Management System (FMS)</strong>. This guide will help you understand how to add, view, and manage entries efficiently through each stage of the billing process.</p>

                    <div>
                        <h2 class="text-lg font-semibold text-indigo-500 mt-3 mb-1">1. Adding a New Entry</h2>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Click the <strong class="text-indigo-600">"Add Entry"</strong> button.</li>
                            <li>Fill in all required fields in the form.</li>
                            <li>The <strong>UID</strong> is auto-generated.</li>
                            <li>Select <strong>at least one “Requirement”</strong>.</li>
                            <li>If <strong>“GST Bill”</strong> is selected, provide a valid <strong>GST Number</strong>.</li>
                            <li>Click <strong class="text-indigo-600">“Add Entry”</strong> to save the new record.</li>
                        </ul>
                    </div>

                    <div>
                        <h2 class="text-lg font-semibold text-indigo-500 mt-3 mb-1">2. Viewing and Managing Entries</h2>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>All entries are displayed in the main table.</li>
                            <li>Use the <strong>search bar</strong> to locate specific entries.</li>
                            <li>Click on table headers (e.g., UID, Timestamp) to <strong>sort</strong> the records.</li>
                            <li>Click the <span class="inline-flex items-center justify-center h-5 w-5 bg-blue-100 text-blue-600 rounded-full align-middle">👁️</span> icon in a row to view <strong>detailed information</strong>.</li>
                        </ul>
                    </div>

                    <div>
                        <h2 class="text-lg font-semibold text-indigo-500 mt-3 mb-1">3. Processing Entries Through Stages</h2>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Open the <strong>Entry Details</strong> page.</li>
                            <li>In the <strong>Process Timeline</strong> section:
                                <ul class="list-circle list-inside ml-5 space-y-1">
                                    <li>The current actionable step will show a <strong>“Take Action”</strong> button.</li>
                                    <li>Click <strong>“Take Action”</strong> and confirm to proceed to the <strong>next stage</strong>.</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    
                    <div>
                        <h3 class="text-md font-medium text-indigo-500 mt-3 mb-1">Special Case – Payment Receive</h3>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>You'll be prompted to confirm if the payment is:
                                <ul class="list-circle list-inside ml-5 space-y-1">
                                    <li><strong>Complete</strong> → Skips to <strong>Payment Completion</strong>.</li>
                                    <li><strong>Incomplete</strong> → Proceeds to <strong>Due Follow-up</strong>.</li>
                                </ul>
                            </li>
                            <li>The timeline displays up to the <strong>current actionable step</strong> only.</li>
                        </ul>
                    </div>

                    <div>
                        <h2 class="text-lg font-semibold text-indigo-500 mt-3 mb-1">4. Other Actions in Entry Details</h2>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li><strong><span class="text-orange-600">🛑 Mark as Closed-Lost:</span></strong> Click the “thumbs down” icon to finalize and close the entry.</li>
                            <li><strong><span class="text-red-600">🗑️ Delete Entry:</span></strong> Click the “trash can” icon to permanently delete the entry (confirmation required).</li>
                        </ul>
                    </div>

                    <div>
                        <h2 class="text-lg font-semibold text-indigo-500 mt-3 mb-1">5. Task Responsibilities</h2>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Click the <strong>“Responsibilities”</strong> button to view who is assigned to each task in the billing process.</li>
                        </ul>
                    </div>

                    <div>
                        <h2 class="text-lg font-semibold text-indigo-500 mt-3 mb-1">6. Syncing Data</h2>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Click the <strong>🔄 Sync icon</strong> in the top header to refresh and load the latest data.</li>
                        </ul>
                    </div>

                    <div class="mt-6 p-4 bg-green-50 border-l-4 border-green-500 text-green-700 rounded-md">
                        <p class="font-bold">🔧 Note:</p>
                        <p>This guide is customized for the <strong>Billing Follow-up Management System (FMS)</strong> based on our internal workflow. If you face any issues or need help, please contact the <strong>MIS Executive</strong> for support and clarification.</p>
                    </div>
                </div>
                <div class="mt-6 text-right">
                    <button type="button" id="okHowToUseModalButton" class="btn btn-primary">OK</button>
                </div>
            </section>
        </div></div>


        <section id="entriesListSection" class="mb-10">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">All Recorded Entries</h2>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0">
                <input type="text" id="searchInput" placeholder="Search entries..." class="p-2 border border-gray-300 rounded-md shadow-sm w-full sm:w-auto">
                </div>
            <div id="tableStatus" class="text-center p-4 text-gray-500">Loading entries...</div>
            <div class="table-container overflow-x-auto bg-white rounded-lg shadow">
                <table class="min-w-full divide-y divide-gray-200 responsive-table">
                    <thead id="entriesTableHead" class="bg-gray-50">
                        <tr>
                            </tr>
                    </thead>
                    <tbody id="entriesTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
             <div id="paginationControls" class="mt-4 flex justify-center items-center space-x-2"></div>
        </section>
    </div>

    <div id="messageAlertModal" class="modal"><div class="modal-content-wrapper">
        <div class="modal-content">
            <span class="close-button" onclick="closeAlertModal()">&times;</span> 
            <p id="modalMessage" class="text-gray-700 text-center"></p>
            <div class="mt-6 text-center default-modal-buttons"><button onclick="closeAlertModal()" class="btn btn-primary">OK</button></div>
            <div class="mt-6 flex justify-center space-x-3 confirm-buttons" style="display:none;"><button id="modalCancelButton" class="btn btn-secondary">Cancel</button><button id="modalConfirmButton" class="btn btn-danger">Confirm</button></div>
            <div class="mt-6 flex justify-center space-x-3 custom-choice-buttons" style="display:none;">
                </div>
        </div>
    </div></div>
    
    <footer class="py-6 text-center text-sm text-gray-500">
        © 2025 Build Wealth Realtors. All rights reserved.
    </footer>

    <script>
        // --- CONFIGURATION & GLOBAL VARS ---
        const VIEW_ENTRIES_URL = 'https://script.google.com/macros/s/AKfycby6f7A3twTLR4hIbwAQSK0kAtm4iekmEjKxeS6L_5D4499VjIkqQ0vCfwfyrcESL3gH/exec'; 
        const MODIFY_ENTRIES_URL = 'https://sheetdb.io/api/v1/nydthm8eqg4w4'; 
        
        const ITEMS_PER_PAGE = 10;
        let currentPage = 1;
        let allEntries = [];
        let nextUidNumber = 1; 
        let currentSortColumn = 'systemTimestamp'; 
        let currentSortDirection = 'desc'; 

        const STEP_LEAD_TIMES = { 
            customerConfirmation: 2, billPreparation: 1, invoiceGeneration: 1, billReceivingFollowup: 2,
            paymentFollowup: 1, paymentReceive: 1, dueFollowup: 2, paymentArrangement: 2, paymentCompletion: 1
        };

        const STATUS_MAP = {
            STEP1_COMPLETE: "Entry Added - Awaiting Customer Confirmation",
            STEP2_COMPLETE: "Customer Confirmed - Awaiting Bill Prep",
            STEP3_COMPLETE: "Bill Prepared - Awaiting Invoice Generation",
            STEP4_COMPLETE: "Invoice Generated - Awaiting Bill Receiving Followup",
            STEP5_COMPLETE: "Bill Followed Up - Awaiting Payment Followup",
            STEP6_COMPLETE: "Payment Followed Up - Awaiting Payment Receive",
            STEP7_COMPLETE: "Payment Received - Awaiting Next Action", 
            STEP8_COMPLETE: "Due Followed Up - Awaiting Payment Arrangement",
            STEP9_COMPLETE: "Payment Arrangement Made - Awaiting Payment Completion",
            STEP10_COMPLETE: "Payment Completed",
            CLOSED_LOST: "Closed - Lost" 
        };
        
        const STEP_NAMES = {
            entry: "Entry Creation (S1)", customerConfirmation: "Customer Confirmation (S2)", billPreparation: "Bill Preparation (S3)",
            invoiceGeneration: "Invoice Generation (S4)", billReceivingFollowup: "Bill Receiving Followup (S5)",
            paymentFollowup: "Payment Followup (S6)", paymentReceive: "Payment Receive (S7)", dueFollowup: "Due Followup (S8)",
            paymentArrangement: "Payment Arrangement (S9)", paymentCompletion: "Payment Completion (S10)"
        };

        const STEP_ACTION_CONFIG = {
            customerConfirmation: { nextStepKey: 'billPreparation', newStatus: STATUS_MAP.STEP2_COMPLETE, buttonClass: 'btn-success', buttonText: 'Take Action' },
            billPreparation:    { nextStepKey: 'invoiceGeneration', newStatus: STATUS_MAP.STEP3_COMPLETE, buttonClass: 'btn-warning', buttonText: 'Take Action' },
            invoiceGeneration:  { nextStepKey: 'billReceivingFollowup', newStatus: STATUS_MAP.STEP4_COMPLETE, buttonClass: 'btn-info', buttonText: 'Take Action' },
            billReceivingFollowup: { nextStepKey: 'paymentFollowup', newStatus: STATUS_MAP.STEP5_COMPLETE, buttonClass: 'btn-primary', buttonText: 'Take Action' },
            paymentFollowup:    { nextStepKey: 'paymentReceive', newStatus: STATUS_MAP.STEP6_COMPLETE, buttonClass: 'btn-primary', buttonText: 'Take Action' },
            paymentReceive:     { nextStepKey: 'dueFollowup', newStatus: STATUS_MAP.STEP7_COMPLETE, buttonClass: 'btn-success', buttonText: 'Take Action' }, 
            dueFollowup:        { nextStepKey: 'paymentArrangement', newStatus: STATUS_MAP.STEP8_COMPLETE, buttonClass: 'btn-primary', buttonText: 'Take Action' },
            paymentArrangement: { nextStepKey: 'paymentCompletion', newStatus: STATUS_MAP.STEP9_COMPLETE, buttonClass: 'btn-warning', buttonText: 'Take Action' },
            paymentCompletion:  { nextStepKey: null, newStatus: STATUS_MAP.STEP10_COMPLETE, buttonClass: 'btn-success', buttonText: 'Take Action' }
        };
        
        const tableHeadersConfig = [
            { key: 'uid', label: 'UID', sortable: true },
            { key: 'actualTimestamp_entry', label: 'Timestamp', sortable: true, isDate: true },
            { key: 'billingName', label: 'Billing Name', sortable: true },
            { key: 'status', label: 'Status', sortable: true },
            { key: 'category', label: 'Category', sortable: true },
            { key: 'assignedBy', label: 'Assigned By', sortable: true },
            { key: 'nextPlannedActionOn', label: 'Next Planned On', sortable: true, isDate: true, customRender: (entry) => getNextPlannedActionTimestamp(entry) },
            { key: 'actions', label: 'Actions', sortable: false }
        ];


        // --- DOM ELEMENTS ---
        const entryForm = document.getElementById('billingEntryForm');
        const addEntrySectionModal = document.getElementById('addEntrySectionModal');
        const openEntryFormModalButton = document.getElementById('openEntryFormModalButton');
        const closeEntryFormModalButton = document.getElementById('closeEntryFormModalButton');
        const submitButton = document.getElementById('submitButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const uidField = document.getElementById('uid');
        const entryTimestampField = document.getElementById('entryTimestamp');
        const requirementError = document.getElementById('requirementError');
        const gstBillSelect = document.getElementById('gstBill');
        const gstNumberInput = document.getElementById('gstNumber');
        const clearFormButton = document.getElementById('clearFormButton');

        const doerInfoModal = document.getElementById('doerInfoModal');
        const openDoerInfoModalButton = document.getElementById('openDoerInfoModalButton');
        const closeDoerInfoModalButton = document.getElementById('closeDoerInfoModalButton');
        
        const howToUseModal = document.getElementById('howToUseModal'); 
        const openHowToUseModalButton = document.getElementById('openHowToUseModalButton'); 
        const closeHowToUseModalButton = document.getElementById('closeHowToUseModalButton'); 
        const okHowToUseModalButton = document.getElementById('okHowToUseModalButton'); 


        const entryDetailsModal = document.getElementById('entryDetailsModal'); 
        const detailsModalTitle = document.getElementById('detailsModalTitle');
        const detailsModalSubtitle = document.getElementById('detailsModalSubtitle'); 
        const detailsModalContent = document.getElementById('detailsModalContent');

        const messageAlertModal = document.getElementById('messageAlertModal');
        const modalMessage = document.getElementById('modalMessage');
        const defaultModalButtons = messageAlertModal.querySelector('.default-modal-buttons');
        const confirmModalButtons = messageAlertModal.querySelector('.confirm-buttons');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const modalCancelButton = document.getElementById('modalCancelButton');
        const customChoiceButtonsContainer = messageAlertModal.querySelector('.custom-choice-buttons');


        const entriesTableHead = document.getElementById('entriesTableHead'); 
        const entriesTableBody = document.getElementById('entriesTableBody');
        const tableStatus = document.getElementById('tableStatus');
        // const refreshButton = document.getElementById('refreshButton'); // Removed
        const searchInput = document.getElementById('searchInput');
        const paginationControls = document.getElementById('paginationControls');

        const scorecardTotalEntries = document.getElementById('scorecardTotalEntries');
        const scorecardPendingConfirmation = document.getElementById('scorecardPendingConfirmation');
        const scorecardAwaitingBillPrep = document.getElementById('scorecardAwaitingBillPrep');
        const scorecardInvoiceGenerated = document.getElementById('scorecardInvoiceGenerated');
        const scorecardPaymentFollowup = document.getElementById('scorecardPaymentFollowup');
        const scorecardPaymentCompleted = document.getElementById('scorecardPaymentCompleted');
        const entranceAnimationOverlay = document.getElementById('entranceAnimationOverlay');


        // --- MODAL CONTROL FUNCTIONS ---
        function openModal(modalElement) {
            const modalContent = modalElement.querySelector('.modal-content');
            if (modalContent) {
                modalContent.classList.remove('modal-popup-active');
                void modalContent.offsetWidth; 
                modalContent.classList.add('modal-popup-active');
            }
            modalElement.style.display = "block";
        }
        function closeModal(modalElement) { 
            const modalContent = modalElement.querySelector('.modal-content');
            if (modalContent) {
                 // modalContent.classList.remove('modal-popup-active'); 
            }
            modalElement.style.display = "none"; 
        }

        function openFormModal() { openModal(addEntrySectionModal); clearForm(); }
        function openDoerModal() { openModal(doerInfoModal); }
        function openHowToUse() { openModal(howToUseModal); } 
        
        function openEntryDetailsModal(entryId) {
            const entry = allEntries.find(e => e.id === entryId); 
            if (!entry) {
                showUserAlert("Error: Could not find entry details.", "error");
                return;
            }
            detailsModalTitle.textContent = `Entry Details - ${entry.uid}`;
            detailsModalSubtitle.textContent = `Current Status: ${entry.status}`; 
            populateDetailsModal(entry); 
            openModal(entryDetailsModal);
        }

        function showUserAlert(message, type = 'info', onConfirm = null, customButtons = null) {
            modalMessage.textContent = message;
            openModal(messageAlertModal); // This will now apply the animation via openModal's logic

            defaultModalButtons.style.display = 'none';
            confirmModalButtons.style.display = 'none';
            customChoiceButtonsContainer.style.display = 'none';
            customChoiceButtonsContainer.innerHTML = ''; 

            if (type === 'confirm' && onConfirm) {
                confirmModalButtons.style.display = 'flex';
                modalConfirmButton.textContent = 'Confirm'; 
                modalConfirmButton.onclick = () => { onConfirm(); }; 
                modalCancelButton.onclick = closeAlertModal;
            } else if (type === 'choice' && customButtons) {
                customChoiceButtonsContainer.style.display = 'flex';
                customButtons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    button.textContent = btnConfig.text;
                    button.className = `btn ${btnConfig.class || 'btn-secondary'} ml-2`; 
                    button.onclick = () => {
                        closeAlertModal(); 
                        btnConfig.handler();
                    };
                    customChoiceButtonsContainer.appendChild(button);
                });
                const cancelBtnChoice = document.createElement('button');
                cancelBtnChoice.textContent = "Cancel";
                cancelBtnChoice.className = "btn btn-secondary ml-2";
                cancelBtnChoice.onclick = closeAlertModal;
                customChoiceButtonsContainer.insertBefore(cancelBtnChoice, customChoiceButtonsContainer.firstChild);


            } else { 
                defaultModalButtons.style.display = 'block';
            }
            
            modalMessage.classList.remove('text-green-600', 'text-red-600');
            if (type === 'success') modalMessage.classList.add('text-green-600');
            if (type === 'error') modalMessage.classList.add('text-red-600');
        }
        function closeAlertModal() { closeModal(messageAlertModal); }
        
        window.onclick = (event) => { 
            const modals = [addEntrySectionModal, doerInfoModal, entryDetailsModal, messageAlertModal, howToUseModal]; 
            modals.forEach(modal => { if (event.target == modal) closeModal(modal); });
        }
        
        // --- UTILITY FUNCTIONS ---
        function setButtonLoading(isLoading, button = submitButton, spinner = loadingSpinner) {
            if (!button) return;
            button.disabled = isLoading; button.classList.toggle('opacity-50', isLoading);
            if (spinner) spinner.classList.toggle('hidden', !isLoading);
        }

        function formatDateForDisplay(dateTimeStringOrObject) {
            if (!dateTimeStringOrObject || dateTimeStringOrObject === 'N/A') return 'N/A';
            let date;
            if (dateTimeStringOrObject instanceof Date) {
                date = dateTimeStringOrObject;
            } else {
                const customFormatRegex = /^(\d{2})-([A-Za-z]{3})-(\d{4}) (\d{2}):(\d{2}):(\d{2}) (AM|PM)$/;
                const match = typeof dateTimeStringOrObject === 'string' ? dateTimeStringOrObject.match(customFormatRegex) : null;
                if (match) {
                    const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
                    let hours = parseInt(match[4], 10);
                    if (match[7] === 'PM' && hours < 12) hours += 12;
                    if (match[7] === 'AM' && hours === 12) hours = 0; 
                    date = new Date(match[3], months[match[2]], match[1], hours, match[5], match[6]);
                } else {
                    date = new Date(dateTimeStringOrObject); 
                }
            }

            if (isNaN(date.getTime())) {
                return dateTimeStringOrObject.toString(); 
            }
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const day = String(date.getDate()).padStart(2, '0');
            const monthName = months[date.getMonth()];
            const year = date.getFullYear();
            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; 
            const strHours = String(hours).padStart(2, '0');
            return `${day}-${monthName}-${year} ${strHours}:${minutes}:${seconds} ${ampm}`;
        }

         function formatDateForInput(date) { 
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                date = new Date(); 
            }
            const offset = date.getTimezoneOffset();
            const adjustedDate = new Date(date.getTime() - (offset*60*1000));
            return adjustedDate.toISOString().slice(0,16); 
        }
        function addDays(dateInput, days) { 
            const result = new Date(dateInput); 
            result.setDate(result.getDate() + days);
            return result;
        }
        function calculateTimeDelay(actualTimestamp, plannedTimestamp) {
            if (!actualTimestamp || !plannedTimestamp || actualTimestamp === "N/A" || plannedTimestamp === "N/A" || actualTimestamp === "SKIPPED" || plannedTimestamp === "SKIPPED") return "<span class='text-gray-400'>N/A</span>";
            
            const parseCustomDateString = (dateStr) => {
                if (!dateStr || typeof dateStr !== 'string') return null;
                const parts = dateStr.match(/(\d{2})-([A-Za-z]{3})-(\d{4}) (\d{2}):(\d{2}):(\d{2}) (AM|PM)/);
                if (!parts) return new Date(dateStr); 
                const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
                let hours = parseInt(parts[4], 10);
                if (parts[7] === 'PM' && hours < 12) hours += 12;
                if (parts[7] === 'AM' && hours === 12) hours = 0; 
                return new Date(parts[3], months[parts[2]], parts[1], hours, parts[5], parts[6]);
            };

            const actual = (actualTimestamp instanceof Date) ? actualTimestamp : parseCustomDateString(actualTimestamp);
            const planned = (plannedTimestamp instanceof Date) ? plannedTimestamp : parseCustomDateString(plannedTimestamp);

            if (!actual || isNaN(actual.getTime()) || !planned || isNaN(planned.getTime())) {
                 return "<span class='text-gray-400'>Invalid Date</span>";
            }

            const diff = actual.getTime() - planned.getTime();
            const d = Math.floor(diff/(1000*60*60*24)), h = Math.floor((diff%(1000*60*60*24))/(1000*60*60)), m = Math.floor((diff%(1000*60*60))/(1000*60));
            let delayClass = 'delay-ontime'; let delayText = "On Time";
            if (diff > 0) { 
                delayClass = 'delay-late';
                if (d > 0) delayText = `${d}d late`; else if (h > 0) delayText = `${h}h late`; else if (m > 0) delayText = `${m}m late`; else delayText = "Delayed";
            } else if (diff < 0) { 
                 delayClass = 'delay-early';
                 if (Math.abs(d) > 0) delayText = `${Math.abs(d)}d early`; else if (Math.abs(h) > 0) delayText = `${Math.abs(h)}h early`; else delayText = "Early";
            }
            return `<span class="${delayClass}">${delayText}</span>`;
        }
        function generateAndSetNextUid() {
            let maxNum = 0;
            allEntries.forEach(e => { 
                if (e.uid && e.uid.startsWith('UID')) { 
                    const n = parseInt(e.uid.substring(3),10); 
                    if(!isNaN(n) && n > maxNum) maxNum = n; 
                }
            });
            nextUidNumber = maxNum + 1; 
            uidField.value = `UID${nextUidNumber.toString().padStart(2,'0')}`;
        }
        function clearForm() {
            entryForm.reset(); entryTimestampField.value = formatDateForInput(new Date());
            gstNumberInput.disabled = true; gstNumberInput.required = false; gstNumberInput.parentElement.classList.add('opacity-50');
            requirementError.classList.add('hidden'); generateAndSetNextUid();
        }
        function validateRequirements() {
            const chx = entryForm.querySelectorAll('input[name^="requirement_"]:checked');
            requirementError.classList.toggle('hidden', chx.length > 0); return chx.length > 0;
        }

        // --- SCORECARD FUNCTIONS ---
        function renderScorecards(entries) {
            scorecardTotalEntries.textContent = entries.length;
            scorecardPendingConfirmation.textContent = entries.filter(e => e.status === STATUS_MAP.STEP1_COMPLETE).length;
            scorecardAwaitingBillPrep.textContent = entries.filter(e => e.status === STATUS_MAP.STEP2_COMPLETE).length;
            scorecardInvoiceGenerated.textContent = entries.filter(e => e.status === STATUS_MAP.STEP4_COMPLETE).length;
            scorecardPaymentFollowup.textContent = entries.filter(e => e.status === STATUS_MAP.STEP6_COMPLETE).length;
            scorecardPaymentCompleted.textContent = entries.filter(e => e.status === STATUS_MAP.STEP10_COMPLETE).length;
        }

        // --- TABLE SORTING FUNCTIONS ---
        function initializeTableHeaders() {
            const headerRow = entriesTableHead.querySelector('tr') || entriesTableHead.appendChild(document.createElement('tr'));
            headerRow.innerHTML = ''; 

            tableHeadersConfig.forEach(config => {
                const th = document.createElement('th');
                th.className = 'px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = config.label;
                if (config.sortable) {
                    th.classList.add('sortable-header');
                    th.dataset.sortKey = config.key;
                    th.dataset.isDate = config.isDate || false;
                     if(config.customRender) th.dataset.customRender = 'true';
                    th.addEventListener('click', () => handleSort(config.key));
                     if (config.key === currentSortColumn) { 
                        th.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                }
                headerRow.appendChild(th);
            });
        }
        
        function handleSort(sortKey) {
            if (currentSortColumn === sortKey) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = sortKey;
                currentSortDirection = 'asc';
            }
            applySorting();
            renderTable(allEntries); 
        }

        function applySorting() {
            const sortConfig = tableHeadersConfig.find(h => h.key === currentSortColumn);
            const isDateSort = sortConfig && sortConfig.isDate;
            const hasCustomRender = sortConfig && sortConfig.customRender;

            allEntries.sort((a, b) => {
                let valA = hasCustomRender ? sortConfig.customRender(a).text : a[currentSortColumn];
                let valB = hasCustomRender ? sortConfig.customRender(b).text : b[currentSortColumn];

                if (valA === null || valA === undefined || valA === 'N/A') valA = currentSortDirection === 'asc' ? Infinity : -Infinity;
                if (valB === null || valB === undefined || valB === 'N/A') valB = currentSortDirection === 'asc' ? Infinity : -Infinity;
                
                if (isDateSort) {
                    const parseCustomDate = (dateStr) => {
                        if (!dateStr || typeof dateStr !== 'string' || dateStr === 'N/A') return null;
                        const parts = dateStr.match(/(\d{2})-([A-Za-z]{3})-(\d{4}) (\d{2}):(\d{2}):(\d{2}) (AM|PM)/);
                        if (!parts) return new Date(dateStr); 
                        const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
                        let hours = parseInt(parts[4], 10);
                        if (parts[7] === 'PM' && hours < 12) hours += 12;
                        if (parts[7] === 'AM' && hours === 12) hours = 0; 
                        return new Date(parts[3], months[parts[2]], parts[1], hours, parts[5], parts[6]);
                    };
                    valA = parseCustomDate(valA);
                    valB = parseCustomDate(valB);
                    if (valA === null) valA = currentSortDirection === 'asc' ? Infinity : -Infinity;
                    if (valB === null) valB = currentSortDirection === 'asc' ? Infinity : -Infinity;
                } else if (typeof valA === 'string' && typeof valB === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                } else if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }

                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            entriesTableHead.querySelectorAll('.sortable-header').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sortKey === currentSortColumn) {
                    th.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }


        // --- EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeTableHeaders(); 
            fetchEntries(); 
            gstNumberInput.disabled = true; gstNumberInput.parentElement.classList.add('opacity-50');
            openEntryFormModalButton.addEventListener('click', openFormModal);
            closeEntryFormModalButton.addEventListener('click', () => closeModal(addEntrySectionModal));
            openDoerInfoModalButton.addEventListener('click', openDoerModal);
            closeDoerInfoModalButton.addEventListener('click', () => closeModal(doerInfoModal));
            openHowToUseModalButton.addEventListener('click', openHowToUse); 
            closeHowToUseModalButton.addEventListener('click', () => closeModal(howToUseModal)); 
            okHowToUseModalButton.addEventListener('click', () => closeModal(howToUseModal)); 
            
            gstBillSelect.addEventListener('change', function() {
                const isGst = this.value === 'GST Bill';
                gstNumberInput.disabled = !isGst; gstNumberInput.required = isGst;
                gstNumberInput.parentElement.classList.toggle('opacity-50', !isGst);
                if (!isGst) gstNumberInput.value = '';
            });
            clearFormButton.addEventListener('click', clearForm); modalCancelButton.onclick = closeAlertModal;

             // Dashboard Header JS
            updateDateTime();
            setInterval(updateDateTime, 1000); 

            const syncButton = document.getElementById('syncButton');
            if (syncButton) {
                syncButton.addEventListener('click', () => {
                    const svgIcon = syncButton.querySelector('svg');
                    if (svgIcon) {
                        svgIcon.classList.add('rotate-animate');
                        console.log("Syncing data via dashboard header button...");
                        fetchEntries(); 
                        setTimeout(() => {
                            svgIcon.classList.remove('rotate-animate');
                            console.log("Sync complete.");
                        }, 1000); 
                    }
                });
            }
        });

        entryForm.addEventListener('submit', async function(event) { 
            event.preventDefault(); if (!validateRequirements()) return; setButtonLoading(true);
            const formData = new FormData(entryForm); 
            const entryData = {};
            formData.forEach((v,k) => { if (!k.startsWith('requirement_')) entryData[k] = v; });
            const reqs = []; entryForm.querySelectorAll('input[name^="requirement_"]:checked').forEach(cb => reqs.push(cb.value));
            entryData.requirement = reqs.join(', '); 
            
            entryData.uid = uidField.value; 
            entryData.status = STATUS_MAP.STEP1_COMPLETE; 
            
            const entryTimestampDate = new Date(entryTimestampField.value); 
            entryData.actualTimestamp_entry = formatDateForDisplay(entryTimestampDate); 
            entryData.systemTimestamp = formatDateForDisplay(new Date());
            entryData.plannedTimestamp_customerConfirmation = formatDateForDisplay(addDays(entryTimestampDate, STEP_LEAD_TIMES.customerConfirmation));
            
            Object.keys(STEP_LEAD_TIMES).forEach(stepKey => { 
                 if (stepKey !== 'customerConfirmation') entryData[`plannedTimestamp_${stepKey}`] = null;
                 entryData[`actualTimestamp_${stepKey}`] = null;
                 entryData[`timeDelay_${stepKey}`] = null;
            });
            entryData.isFullPaymentReceived = null; 
            
            try {
                const res = await fetch(MODIFY_ENTRIES_URL, { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({data: [entryData]}) 
                });
                if (res.ok) { 
                    showUserAlert('Entry added successfully! Status: ' + STATUS_MAP.STEP1_COMPLETE, 'success'); 
                    fetchEntries(); 
                    closeModal(addEntrySectionModal); 
                } else { 
                    const errorResult = await res.json().catch(() => ({ message: 'Unknown error, unable to parse response.' }));
                    showUserAlert('Error adding entry: ' + (errorResult.error || errorResult.message || res.statusText), 'error'); 
                }
            } catch (e) { 
                console.error('Error submitting entry:', e); 
                showUserAlert('Network error while submitting entry: ' + e.message, 'error');
            } finally { 
                setButtonLoading(false); 
            }
        });

        // refreshButton.addEventListener('click', fetchEntries); // Removed this line
        searchInput.addEventListener('input', () => { currentPage = 1; applySorting(); renderTable(allEntries); });


        async function processStepCompletion(entryId, buttonElement, currentStepKey, defaultNextStepKey, defaultNewStatus, options = {}) {
            setButtonLoading(true, buttonElement, null);
            const entryIdx = allEntries.findIndex(e => e.id === entryId);
            if (entryIdx === -1) {
                showUserAlert('Error: Entry not found for update.', 'error');
                setButtonLoading(false, buttonElement, null);
                return;
            }

            const now = new Date();
            const entryToUpdateLocally = { ...allEntries[entryIdx] }; 

            const dataToUpdatePayload = {
                status: defaultNewStatus, 
                [`actualTimestamp_${currentStepKey}`]: formatDateForDisplay(now)
            };

            if (entryToUpdateLocally[`plannedTimestamp_${currentStepKey}`]) {
                 const plannedDate = new Date(entryToUpdateLocally[`plannedTimestamp_${currentStepKey}`].replace(/-/g, " ").replace(" AM", "").replace(" PM", ""));
                 if (!isNaN(plannedDate.getTime())) {
                    dataToUpdatePayload[`timeDelay_${currentStepKey}`] = calculateTimeDelay(now, plannedDate).replace(/<[^>]*>?/gm, '');
                 } else {
                    dataToUpdatePayload[`timeDelay_${currentStepKey}`] = "N/A";
                 }
            }

            if (options.skipSteps && options.directToStepKey && options.directToStepNewStatus) {
                options.skipSteps.forEach(stepToSkip => {
                    dataToUpdatePayload[`plannedTimestamp_${stepToSkip}`] = "SKIPPED";
                    dataToUpdatePayload[`actualTimestamp_${stepToSkip}`] = "SKIPPED";
                    dataToUpdatePayload[`timeDelay_${stepToSkip}`] = "SKIPPED";
                });
                dataToUpdatePayload[`plannedTimestamp_${options.directToStepKey}`] = formatDateForDisplay(addDays(now, STEP_LEAD_TIMES[options.directToStepKey]));
                dataToUpdatePayload.status = options.directToStepNewStatus; 
                entryToUpdateLocally.isFullPaymentReceived = true; 
                dataToUpdatePayload.isFullPaymentReceived = true; 
            } else if (defaultNextStepKey && STEP_LEAD_TIMES[defaultNextStepKey]) {
                dataToUpdatePayload[`plannedTimestamp_${defaultNextStepKey}`] = formatDateForDisplay(addDays(now, STEP_LEAD_TIMES[defaultNextStepKey]));
                 if(currentStepKey === 'paymentReceive' && !options.skipSteps) { 
                    entryToUpdateLocally.isFullPaymentReceived = false;
                    dataToUpdatePayload.isFullPaymentReceived = false;
                 }
            } else if (!defaultNextStepKey && defaultNewStatus === STATUS_MAP.STEP10_COMPLETE) {
                // Final step (S10) completion
            }


            try {
                const updateUrl = `${MODIFY_ENTRIES_URL}/id/${entryId}`; 
                const res = await fetch(updateUrl, {
                    method: 'PUT', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: dataToUpdatePayload }) 
                });
                if (res.ok) { 
                    showUserAlert(`Entry ${entryToUpdateLocally.uid} status updated to "${dataToUpdatePayload.status}"!`, 'success');
                    Object.assign(allEntries[entryIdx], dataToUpdatePayload);
                     if (dataToUpdatePayload.hasOwnProperty('isFullPaymentReceived')) {
                        allEntries[entryIdx].isFullPaymentReceived = dataToUpdatePayload.isFullPaymentReceived;
                    }
                    applySorting(); renderTable(allEntries);
                    if (entryDetailsModal.style.display === "block") {
                         const currentModalEntry = allEntries.find(e => e.id === entryId);
                         if(currentModalEntry) populateDetailsModal(currentModalEntry);
                    }
                } else {
                    const errorResult = await res.json().catch(() => ({ message: 'Unknown error' }));
                    showUserAlert('Error updating status: ' + (errorResult.error || errorResult.message || res.statusText), 'error');
                }
            } catch (e) {
                console.error('Error updating status:', e);
                showUserAlert('Network error while updating status: ' + e.message, 'error');
            } finally {
                setButtonLoading(false, buttonElement, null);
            }
        }
        
        async function processCloseLost(entryId, buttonElement) {
            setButtonLoading(true, buttonElement, null);
            const entryIdx = allEntries.findIndex(e => e.id === entryId);
            if (entryIdx === -1) { 
                showUserAlert('Error: Entry not found.', 'error');
                setButtonLoading(false, buttonElement, null);
                return; 
            }

            const entryToUpdate = { ...allEntries[entryIdx] };
            const newStatus = STATUS_MAP.CLOSED_LOST;
            
            const dataToUpdatePayload = { 
                status: newStatus 
            };
            Object.keys(STEP_LEAD_TIMES).forEach(stepKey => {
                dataToUpdatePayload[`plannedTimestamp_${stepKey}`] = null;
                dataToUpdatePayload[`actualTimestamp_${stepKey}`] = entryToUpdate[`actualTimestamp_${stepKey}`] || null; 
                dataToUpdatePayload[`timeDelay_${stepKey}`] = entryToUpdate[`timeDelay_${stepKey}`] || null;
            });
            dataToUpdatePayload.isFullPaymentReceived = null; 

            try {
                const updateUrl = `${MODIFY_ENTRIES_URL}/id/${entryId}`; 
                const res = await fetch(updateUrl, {
                    method: 'PUT', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: dataToUpdatePayload })
                });
                if (res.ok) {
                    showUserAlert(`Entry ${entryToUpdate.uid} marked as "${newStatus}"!`, 'success');
                    Object.assign(allEntries[entryIdx], dataToUpdatePayload);
                    allEntries[entryIdx].status = newStatus; 

                    applySorting(); renderTable(allEntries);
                    closeModal(entryDetailsModal); 
                } else { 
                    const errorResult = await res.json().catch(() => ({ message: 'Unknown error' }));
                    showUserAlert('Error updating status to Closed-Lost: ' + (errorResult.error || errorResult.message || res.statusText), 'error');
                }
            } catch (e) { 
                 console.error('Error marking as Closed-Lost:', e);
                showUserAlert('Network error while updating status: ' + e.message, 'error');
            }
            finally { setButtonLoading(false, buttonElement, null); }
        }


        // --- ENTRY DETAILS MODAL ---
        function populateDetailsModal(entry) {
            detailsModalContent.innerHTML = ''; 
            
            const modalContentSection = entryDetailsModal.querySelector('.modal-content');

            const existingControlsGroup = modalContentSection.querySelector('.modal-controls-group');
            if (existingControlsGroup) {
                existingControlsGroup.remove();
            }

            const controlsGroup = document.createElement('div');
            controlsGroup.className = 'modal-controls-group';

            if (entry.status !== STATUS_MAP.CLOSED_LOST && entry.status !== STATUS_MAP.PAYMENT_COMPLETED) {
                const closeLostButton = document.createElement('button');
                closeLostButton.className = 'modal-control-button close-lost-btn';
                closeLostButton.title = 'Mark as Closed-Lost';
                closeLostButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-hand-thumbs-down-fill" viewBox="0 0 16 16"><path d="M6.956 14.534c.258.282.656.466 1.044.466h.003c.388 0 .786-.184 1.044-.466l.059-.064.062-.065c.17-.178.292-.382.382-.595.072-.166.12-.34.138-.521A3.4 3.4 0 0 0 10.5 11V7a1 1 0 0 0-1-1H6.465a1.12 1.12 0 0 0-.898.46L4.21 7.882a.5.5 0 0 1-.854-.53L4.85 3.85a1.12 1.12 0 0 0-.908-.985l-.002-.001H3.503a1 1 0 0 0-1 1.003Z"/><path d="M13.5 0A1.5 1.5 0 0 0 12 1.5v6.956c0 .417-.163.81-.448 1.106L9.937 11.18H13.5a1.5 1.5 0 0 0 1.5-1.5v-8A1.5 1.5 0 0 0 13.5 0"/></svg>`;
                closeLostButton.onclick = () => {
                    showUserAlert(`Are you sure you want to mark entry "${entry.billingName || entry.uid}" as Closed-Lost? This action cannot be undone.`, 
                    'confirm', 
                    () => { 
                        processCloseLost(entry.id, closeLostButton);
                    });
                };
                controlsGroup.appendChild(closeLostButton);
            }


            const deleteIconButton = document.createElement('button');
            deleteIconButton.className = 'modal-control-button delete-btn'; 
            deleteIconButton.title = 'Delete Entry';
            deleteIconButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm-9.007 1.188L3.61 14.5h8.78l.007-9.312zM4.5 5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M7.5 5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5"/></svg>`;
            deleteIconButton.onclick = () => {
                closeModal(entryDetailsModal); 
                confirmDeleteEntry(entry.id, entry.billingName || entry.uid);
            };
            controlsGroup.appendChild(deleteIconButton);

            const newCloseButton = document.createElement('button');
            newCloseButton.className = 'modal-control-button close-btn';
            newCloseButton.title = 'Close';
            newCloseButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>`;
            newCloseButton.onclick = () => closeModal(entryDetailsModal);
            controlsGroup.appendChild(newCloseButton);
            
            if (modalContentSection) {
                 modalContentSection.insertBefore(controlsGroup, modalContentSection.firstChild);
            }

            const cardDiv = document.createElement('div');
            cardDiv.className = 'crm-card'; 

            const overviewTitle = document.createElement('h2');
            overviewTitle.textContent = 'Client & Deal Overview';
            cardDiv.appendChild(overviewTitle);

            const createSectionItem = (label, value, isHtml = false) => {
                const item = document.createElement('div'); item.className = 'crm-description-item';
                const lbl = document.createElement('div'); lbl.className = 'crm-label'; lbl.textContent = label + ':';
                const val = document.createElement('div'); val.className = 'crm-value';
                if (isHtml) {
                    val.innerHTML = value || '<span class="text-gray-400">N/A</span>';
                } else {
                    val.textContent = value || 'N/A';
                }
                item.append(lbl, val);
                return item;
            };
            
            const row1 = document.createElement('div'); row1.className = 'crm-section-row';
            const idSection = document.createElement('div'); 
            idSection.className = 'crm-section';
            idSection.style.cssText = '--section-color: #3f51b5; --section-bg: rgba(63, 81, 181, 0.07);';
            idSection.innerHTML = `<div class="crm-section-header"><svg viewBox="0 0 24 24"><path d="M12 2L2 7h20L12 2zm0 2.18l6.16 3.25H5.84L12 4.18zM2 9v11h20V9H2zm2 2h16v7H4v-7z"/></svg><span>Identification & Timestamps</span></div><div class="crm-section-content"></div>`;
            idSection.querySelector('.crm-section-content').appendChild(createSectionItem('UID', entry.uid));
            idSection.querySelector('.crm-section-content').appendChild(createSectionItem('Entry Timestamp (S1 Actual)', formatDateForDisplay(entry.actualTimestamp_entry)));
            idSection.querySelector('.crm-section-content').appendChild(createSectionItem('System Timestamp (Creation)', formatDateForDisplay(entry.systemTimestamp)));
            row1.appendChild(idSection);

            const clientSection = document.createElement('div'); 
            clientSection.className = 'crm-section';
            clientSection.style.cssText = '--section-color: #4caf50; --section-bg: rgba(76, 175, 80, 0.07);';
            clientSection.innerHTML = `<div class="crm-section-header"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>Client Details</span></div><div class="crm-section-content"></div>`;
            clientSection.querySelector('.crm-section-content').appendChild(createSectionItem('Billing Name', entry.billingName));
            clientSection.querySelector('.crm-section-content').appendChild(createSectionItem('Billing Address', entry.billingAddress));
            clientSection.querySelector('.crm-section-content').appendChild(createSectionItem('Email ID', entry.emailId));
            clientSection.querySelector('.crm-section-content').appendChild(createSectionItem('Mobile Number', entry.mobileNumber));
            row1.appendChild(clientSection);
            cardDiv.appendChild(row1);

            const row2 = document.createElement('div'); row2.className = 'crm-section-row';
            const dealSection = document.createElement('div'); 
            dealSection.className = 'crm-section';
            dealSection.style.cssText = '--section-color: #ff9800; --section-bg: rgba(255, 152, 0, 0.07);';
            dealSection.innerHTML = `<div class="crm-section-header"><svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h12v2H3v-2z"/></svg><span>Deal & Billing</span></div><div class="crm-section-content"></div>`;
            dealSection.querySelector('.crm-section-content').appendChild(createSectionItem('Category', entry.category));
            dealSection.querySelector('.crm-section-content').appendChild(createSectionItem('Requirement', entry.requirement));
            dealSection.querySelector('.crm-section-content').appendChild(createSectionItem('GST/Non-GST', entry.gstBill));
            if(entry.gstBill === 'GST Bill') dealSection.querySelector('.crm-section-content').appendChild(createSectionItem('GST #', entry.gstNumber));
            dealSection.querySelector('.crm-section-content').appendChild(createSectionItem('Commission Tenure', entry.commissionTenure ? `${entry.commissionTenure} year(s)`: 'N/A'));
            dealSection.querySelector('.crm-section-content').appendChild(createSectionItem('Taxable Value', entry.taxableValue ? `₹${parseFloat(entry.taxableValue).toFixed(2)}` : 'N/A'));
             if (entry.hasOwnProperty('isFullPaymentReceived')) { 
                dealSection.querySelector('.crm-section-content').appendChild(
                    createSectionItem('Full Payment on S7', entry.isFullPaymentReceived === true ? 'Yes' : (entry.isFullPaymentReceived === false ? 'No' : 'N/A'))
                );
            }
            row2.appendChild(dealSection);

            const assignmentSection = document.createElement('div'); 
            assignmentSection.className = 'crm-section';
            assignmentSection.style.cssText = '--section-color: #9c27b0; --section-bg: rgba(156, 39, 176, 0.07);';
            assignmentSection.innerHTML = `<div class="crm-section-header"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"></path></svg><span>Assignment & Status</span></div><div class="crm-section-content"></div>`;
            assignmentSection.querySelector('.crm-section-content').appendChild(createSectionItem('Assigned By (Entry)', entry.assignedBy));
            assignmentSection.querySelector('.crm-section-content').appendChild(createSectionItem('Current Status', entry.status)); 
            row2.appendChild(assignmentSection);
            cardDiv.appendChild(row2);
            
            detailsModalContent.appendChild(cardDiv);

            const timelineOuterSection = document.createElement('div');
            timelineOuterSection.className = 'details-section mt-6'; 
            const timelineTitle = document.createElement('h3');
            timelineTitle.textContent = 'Process Timeline';
            timelineOuterSection.appendChild(timelineTitle);

            const canTakeOverallAction = entry.status !== STATUS_MAP.CLOSED_LOST && entry.status !== STATUS_MAP.PAYMENT_COMPLETED;
            let stopRenderingFurtherSteps = false;

            Object.keys(STEP_NAMES).forEach(stepKey => {
                if (stepKey === 'entry' || stopRenderingFurtherSteps) return; 
                
                const isSkipped = entry[`actualTimestamp_${stepKey}`] === "SKIPPED";
                const trueNextActionableStep = getTrueNextActionableStepKey(entry);

                if (isSkipped && stepKey !== trueNextActionableStep) { 
                    return;
                }


                const stepDiv = document.createElement('div'); stepDiv.className = 'timeline-step';
                const stepTitle = document.createElement('strong'); stepTitle.textContent = STEP_NAMES[stepKey];
                stepDiv.appendChild(stepTitle);
                const stepDetailsGrid = document.createElement('div'); stepDetailsGrid.className = 'timeline-details-grid mt-2'; 
                
                stepDetailsGrid.appendChild(createSectionItem('Planned', formatDateForDisplay(entry[`plannedTimestamp_${stepKey}`]), false)); 
                stepDetailsGrid.appendChild(createSectionItem('Actual', formatDateForDisplay(entry[`actualTimestamp_${stepKey}`]), false)); 
                stepDetailsGrid.appendChild(createSectionItem('Delay', entry[`timeDelay_${stepKey}`] === "SKIPPED" ? "SKIPPED" : calculateTimeDelay(entry[`actualTimestamp_${stepKey}`], entry[`plannedTimestamp_${stepKey}`]) , true)); 
                stepDiv.appendChild(stepDetailsGrid); 

                if (canTakeOverallAction) {
                    let isNextActionableStep = false;
                    let actionConfig = null;
                    const currentStatus = entry.status;

                    if (!entry[`actualTimestamp_${stepKey}`] || entry[`actualTimestamp_${stepKey}`] === "SKIPPED") { 
                        if (currentStatus === STATUS_MAP.STEP1_COMPLETE && stepKey === 'customerConfirmation') { isNextActionableStep = true; actionConfig = STEP_ACTION_CONFIG.customerConfirmation; }
                        else if (currentStatus === STATUS_MAP.STEP2_COMPLETE && stepKey === 'billPreparation') { isNextActionableStep = true; actionConfig = STEP_ACTION_CONFIG.billPreparation; }
                        else if (currentStatus === STATUS_MAP.STEP3_COMPLETE && stepKey === 'invoiceGeneration') { isNextActionableStep = true; actionConfig = STEP_ACTION_CONFIG.invoiceGeneration; }
                        else if (currentStatus === STATUS_MAP.STEP4_COMPLETE && stepKey === 'billReceivingFollowup') { isNextActionableStep = true; actionConfig = STEP_ACTION_CONFIG.billReceivingFollowup; }
                        else if (currentStatus === STATUS_MAP.STEP5_COMPLETE && stepKey === 'paymentFollowup') { isNextActionableStep = true; actionConfig = STEP_ACTION_CONFIG.paymentFollowup; }
                        else if (currentStatus === STATUS_MAP.STEP6_COMPLETE && stepKey === 'paymentReceive') { isNextActionableStep = true; actionConfig = STEP_ACTION_CONFIG.paymentReceive; }
                        else if (currentStatus === STATUS_MAP.STEP7_COMPLETE) {
                            if (entry.isFullPaymentReceived === false && stepKey === 'dueFollowup') { 
                                isNextActionableStep = true; actionConfig = STEP_ACTION_CONFIG.dueFollowup;
                            } else if (entry.isFullPaymentReceived === true && stepKey === 'paymentCompletion') {
                                isNextActionableStep = true; actionConfig = STEP_ACTION_CONFIG.paymentCompletion;
                            }
                        }
                        else if (currentStatus === STATUS_MAP.STEP8_COMPLETE && stepKey === 'paymentArrangement') { isNextActionableStep = true; actionConfig = STEP_ACTION_CONFIG.paymentArrangement; }
                        else if (currentStatus === STATUS_MAP.STEP9_COMPLETE && stepKey === 'paymentCompletion') { isNextActionableStep = true; actionConfig = STEP_ACTION_CONFIG.paymentCompletion; }
                    }

                    if (isNextActionableStep && actionConfig) {
                        const actionButton = document.createElement('button');
                        actionButton.textContent = actionConfig.buttonText || 'Take Action';
                        actionButton.className = `btn ${actionConfig.buttonClass || 'btn-primary'} btn-take-action`;
                        
                        actionButton.onclick = () => { 
                            const stepDisplayName = STEP_NAMES[stepKey] || "this step";
                            if (stepKey === 'paymentReceive') { 
                                const s7Handler = (isComplete) => {
                                    showUserAlert(`Confirm payment received as "${isComplete ? 'Complete' : 'Incomplete'}"?`, 'confirm', () => {
                                        processPaymentReceiveChoice(entry.id, actionButton, isComplete);
                                    });
                                };
                                showUserAlert(
                                    'Is the payment received completely for this entry?', 
                                    'choice', 
                                    null, 
                                    [
                                        { text: 'Payment Complete', class: 'btn-success', handler: () => s7Handler(true) },
                                        { text: 'Payment Incomplete', class: 'btn-warning', handler: () => s7Handler(false) }
                                    ]
                                );
                            } else { 
                                showUserAlert(`Are you sure you want to complete ${stepDisplayName} and proceed?`, 
                                'confirm', 
                                async () => { 
                                    closeAlertModal(); 
                                    await processStepCompletion(entry.id, actionButton, stepKey, actionConfig.nextStepKey, actionConfig.newStatus);
                                });
                            }
                        };
                        stepDiv.appendChild(actionButton); 
                    }
                }
                timelineOuterSection.appendChild(stepDiv);
                
                if (stepKey === trueNextActionableStep && (!entry[`actualTimestamp_${stepKey}`] || entry[`actualTimestamp_${stepKey}`] === "SKIPPED")) {
                    if (!(stepKey === 'paymentReceive' && entry.isFullPaymentReceived === true)) {
                         stopRenderingFurtherSteps = true;
                    }
                }
            });
            detailsModalContent.appendChild(timelineOuterSection);
        }
        
        function getTrueNextActionableStepKey(entry) {
            if (entry.status === STATUS_MAP.CLOSED_LOST || entry.status === STATUS_MAP.PAYMENT_COMPLETED) return null;

            if (entry.status === STATUS_MAP.STEP1_COMPLETE) return 'customerConfirmation';
            if (entry.status === STATUS_MAP.STEP2_COMPLETE) return 'billPreparation';
            if (entry.status === STATUS_MAP.STEP3_COMPLETE) return 'invoiceGeneration';
            if (entry.status === STATUS_MAP.STEP4_COMPLETE) return 'billReceivingFollowup';
            if (entry.status === STATUS_MAP.STEP5_COMPLETE) return 'paymentFollowup';
            if (entry.status === STATUS_MAP.STEP6_COMPLETE) return 'paymentReceive';
            if (entry.status === STATUS_MAP.STEP7_COMPLETE) {
                return entry.isFullPaymentReceived === true ? 'paymentCompletion' : 'dueFollowup';
            }
            if (entry.status === STATUS_MAP.STEP8_COMPLETE) return 'paymentArrangement';
            if (entry.status === STATUS_MAP.STEP9_COMPLETE) return 'paymentCompletion';
            return null; 
        }
        
        async function processPaymentReceiveChoice(entryId, buttonElement, isFullPaymentReceived) {
            setButtonLoading(true, buttonElement, null);
            const entryIdx = allEntries.findIndex(e => e.id === entryId);
            if (entryIdx === -1) { /* ... error handling ... */ setButtonLoading(false, buttonElement, null); return; }

            const now = new Date();
            const entryToUpdate = { ...allEntries[entryIdx] };
            const currentStepKey = 'paymentReceive';

            const dataToUpdatePayload = {
                id: entryId, 
                status: STATUS_MAP.STEP7_COMPLETE,
                [`actualTimestamp_${currentStepKey}`]: formatDateForDisplay(now),
                isFullPaymentReceived: isFullPaymentReceived 
            };

            if (entryToUpdate[`plannedTimestamp_${currentStepKey}`]) {
                const plannedDate = new Date(entryToUpdate[`plannedTimestamp_${currentStepKey}`].replace(/-/g, " ").replace(" AM", "").replace(" PM", ""));
                if (!isNaN(plannedDate.getTime())) {
                    dataToUpdatePayload[`timeDelay_${currentStepKey}`] = calculateTimeDelay(now, plannedDate).replace(/<[^>]*>?/gm, '');
                } else {
                     dataToUpdatePayload[`timeDelay_${currentStepKey}`] = "N/A";
                }
            }

            if (isFullPaymentReceived) {
                dataToUpdatePayload[`plannedTimestamp_dueFollowup`] = "SKIPPED";
                dataToUpdatePayload[`actualTimestamp_dueFollowup`] = "SKIPPED";
                dataToUpdatePayload[`timeDelay_dueFollowup`] = "SKIPPED";
                dataToUpdatePayload[`plannedTimestamp_paymentArrangement`] = "SKIPPED";
                dataToUpdatePayload[`actualTimestamp_paymentArrangement`] = "SKIPPED";
                dataToUpdatePayload[`timeDelay_paymentArrangement`] = "SKIPPED";
                dataToUpdatePayload[`plannedTimestamp_paymentCompletion`] = formatDateForDisplay(addDays(now, STEP_LEAD_TIMES.paymentCompletion));
            } else {
                dataToUpdatePayload[`plannedTimestamp_dueFollowup`] = formatDateForDisplay(addDays(now, STEP_LEAD_TIMES.dueFollowup));
                dataToUpdatePayload[`plannedTimestamp_paymentArrangement`] = null;
                dataToUpdatePayload[`actualTimestamp_paymentArrangement`] = null;
                dataToUpdatePayload[`timeDelay_paymentArrangement`] = null;
                dataToUpdatePayload[`plannedTimestamp_paymentCompletion`] = null;
                dataToUpdatePayload[`actualTimestamp_paymentCompletion`] = null;
                dataToUpdatePayload[`timeDelay_paymentCompletion`] = null;
            }

            try {
                 const updateUrl = `${MODIFY_ENTRIES_URL}/id/${entryId}`; 
                 const res = await fetch(updateUrl, {
                    method: 'PUT', 
                    mode: 'cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: dataToUpdatePayload}) 
                });
                if (res.ok) { 
                    showUserAlert(`Payment Receive (S7) processed as ${isFullPaymentReceived ? 'Fully Paid' : 'Incomplete'}.`, 'success');
                    Object.assign(allEntries[entryIdx], dataToUpdatePayload);
                    applySorting(); renderTable(allEntries);
                    if (entryDetailsModal.style.display === "block") {
                        populateDetailsModal(allEntries[entryIdx]);
                    }
                } else { 
                    const errorResult = await res.json().catch(() => ({ message: 'Unknown error' }));
                    showUserAlert('Error updating S7: ' + (errorResult.error || errorResult.message || res.statusText), 'error');
                 }
            } catch (e) { 
                console.error('Error processing S7 choice:', e);
                showUserAlert('Network error processing S7: ' + e.message, 'error');
             }
            finally { setButtonLoading(false, buttonElement, null); }
        }


        async function fetchEntries() {
            tableStatus.textContent = 'Loading entries...'; 
            tableStatus.classList.remove('hidden');
            entriesTableBody.innerHTML = ''; 
            paginationControls.innerHTML = '';
            const entranceOverlay = document.getElementById('entranceAnimationOverlay');


            if (VIEW_ENTRIES_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') { 
                console.warn("VIEW_ENTRIES_URL is still the placeholder. Using local demo data for fetchEntries.");
                 if (allEntries.length === 0) { 
                    const now = new Date(); const step1Time = new Date(now.getTime() - 25 * 24 * 60 * 60 * 1000); 
                    allEntries = [ 
                        { 
                            id: 'demo1', uid: 'UID01', entryTimestamp: formatDateForInput(step1Time), billingName: 'Alpha Services (Demo)', category: 'Residential', assignedBy: 'Sanat Majumdar', status: STATUS_MAP.STEP1_COMPLETE, 
                            requirement: "Buy, Rent", gstBill: "GST Bill", gstNumber:"GSTALPHA123", commissionTenure:"1", taxableValue: "50000", billingAddress: "123 Alpha St", emailId:"alpha@example.com", mobileNumber:"9998887770",
                            actualTimestamp_entry: formatDateForDisplay(step1Time), 
                            plannedTimestamp_customerConfirmation: formatDateForDisplay(addDays(step1Time, STEP_LEAD_TIMES.customerConfirmation)), 
                            actualTimestamp_customerConfirmation: null, timeDelay_customerConfirmation: null,
                            systemTimestamp: formatDateForDisplay(step1Time),
                            isFullPaymentReceived: null 
                        }
                    ];
                }
                applySorting(); 
                renderTable(allEntries); generateAndSetNextUid();
                tableStatus.classList.toggle('hidden', allEntries.length > 0);
                if (allEntries.length === 0) tableStatus.textContent = 'No entries (demo).'; 
                if(entranceOverlay) entranceOverlay.classList.add('hidden'); 
                return;
            }
            try {
                const res = await fetch(`${VIEW_ENTRIES_URL}?action=getEntries`); 
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Failed to fetch: ${res.status} ${res.statusText} - ${errorText}`);
                }
                const result = await res.json();
                console.log('Raw response from Apps Script:', result); 

                let dataToProcess = [];
                if (result && result.success && Array.isArray(result.data)) { 
                    dataToProcess = result.data;
                } else if (Array.isArray(result)) { 
                     console.warn("Apps Script returned a direct array. Expected {success: true, data: [...]}. Adapting...");
                    dataToProcess = result;
                } else {
                    tableStatus.textContent = 'Error fetching entries: '+(result.message ||'Invalid data format received from script.'); 
                    showUserAlert('Error fetching entries: '+(result.message ||'Invalid data format received from script.'),'error'); 
                    if(entranceOverlay) entranceOverlay.classList.add('hidden');
                    return; 
                }
                
                allEntries = dataToProcess.map(e=>({...e, 
                    isFullPaymentReceived: e.isFullPaymentReceived === 'true' ? true : (e.isFullPaymentReceived === 'false' ? false : null)
                })).sort((a,b) => {
                    let dateA, dateB;
                    try { dateA = new Date(a.systemTimestamp.replace(/-/g, " ").replace(" AM", "").replace(" PM", "")); } catch { dateA = 0; }
                    try { dateB = new Date(b.systemTimestamp.replace(/-/g, " ").replace(" AM", "").replace(" PM", "")); } catch { dateB = 0; }
                    if (isNaN(dateA.getTime())) dateA = 0;
                    if (isNaN(dateB.getTime())) dateB = 0;
                    return dateB - dateA; 
                }); 
                currentPage = 1; 
                applySorting(); 
                renderTable(allEntries); 
                generateAndSetNextUid();
                tableStatus.classList.toggle('hidden', allEntries.length > 0);
                if (allEntries.length === 0) tableStatus.textContent = 'No entries found.';
                
            } catch (e) { 
                console.error('Error fetching entries:', e); 
                tableStatus.textContent = 'Failed to load entries. Check console and SCRIPT_URL.'; 
                showUserAlert('Network error while fetching entries: '+e.message,'error'); 
            } finally {
                if(entranceOverlay) entranceOverlay.classList.add('hidden'); 
            }
        }
        function renderTable(entries) { 
            entriesTableBody.innerHTML = ''; paginationControls.innerHTML = ''; 
            const searchTerm = searchInput.value.toLowerCase();
            const filtered = entries.filter(e => [e.uid, e.actualTimestamp_entry, e.billingName, e.status, e.category, e.assignedBy].some(v => String(v).toLowerCase().includes(searchTerm)));
            
            renderScorecards(allEntries);

            tableStatus.classList.toggle('hidden', filtered.length > 0);
             if (filtered.length === 0) {
                if (entries.length > 0 && searchTerm) {
                    tableStatus.textContent = 'No entries match your search.';
                } else if (entries.length === 0 && VIEW_ENTRIES_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') { 
                     tableStatus.textContent = 'No entries found.';
                } else if (entries.length === 0) {
                    tableStatus.textContent = 'No entries (demo mode).';
                }
            }

            const paginated = filtered.slice((currentPage-1)*ITEMS_PER_PAGE, (currentPage-1)*ITEMS_PER_PAGE + ITEMS_PER_PAGE);
            
            paginated.forEach((entry, idx) => {
                const r = entriesTableBody.insertRow(); r.className = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'; 
                tableHeadersConfig.forEach(hConfig => {
                    if (hConfig.key === 'actions') return; 
                    const c = r.insertCell(); 
                    let cellValue;
                    let cellHtml = '';
                    let isOverdue = false;

                    if (hConfig.customRender) {
                        const renderResult = hConfig.customRender(entry);
                        cellValue = renderResult.text || 'N/A';
                        isOverdue = renderResult.isOverdue || false;
                    } else {
                        cellValue = entry[hConfig.key];
                        cellValue = (hConfig.isDate && cellValue) ? formatDateForDisplay(cellValue) : (cellValue || 'N/A');
                    }
                    
                    if (hConfig.key === 'status') {
                        let statusClass = 'status-default';
                        if (entry.status === STATUS_MAP.STEP1_COMPLETE) statusClass = 'status-entry-added-awaiting-customer-confirmation';
                        else if (entry.status === STATUS_MAP.STEP2_COMPLETE) statusClass = 'status-customer-confirmed-awaiting-bill-prep';
                        else if (entry.status === STATUS_MAP.STEP3_COMPLETE) statusClass = 'status-bill-prepared-awaiting-invoice-generation';
                        else if (entry.status === STATUS_MAP.STEP4_COMPLETE) statusClass = 'status-invoice-generated-awaiting-bill-receiving-followup';
                        else if (entry.status === STATUS_MAP.STEP5_COMPLETE) statusClass = 'status-bill-followed-up-awaiting-payment-followup';
                        else if (entry.status === STATUS_MAP.STEP6_COMPLETE) statusClass = 'status-payment-followed-up-awaiting-payment-receive';
                        else if (entry.status === STATUS_MAP.STEP7_COMPLETE) statusClass = 'status-payment-received-awaiting-next-action';
                        else if (entry.status === STATUS_MAP.STEP8_COMPLETE) statusClass = 'status-due-followed-up-awaiting-payment-arrangement';
                        else if (entry.status === STATUS_MAP.STEP9_COMPLETE) statusClass = 'status-payment-arrangement-made-awaiting-payment-completion';
                        else if (entry.status === STATUS_MAP.STEP10_COMPLETE) statusClass = 'status-payment-completed';
                        else if (entry.status === STATUS_MAP.CLOSED_LOST) statusClass = 'status-closed-lost';
                        cellHtml = `<span class="status-badge ${statusClass}">${cellValue}</span>`;
                    } else if (isOverdue) {
                        cellHtml = `<span class="overdue-task">${cellValue}</span>`;
                    } else {
                        cellHtml = cellValue;
                    }
                    c.innerHTML = cellHtml; 
                    c.setAttribute('data-label',hConfig.label); 
                    c.className='px-3 py-4 whitespace-nowrap text-sm text-gray-700'; 
                });
                const actCell = r.insertCell(); actCell.setAttribute('data-label','Actions'); actCell.className='px-3 py-4 whitespace-nowrap text-sm text-gray-700 text-right md:text-left flex items-center space-x-1';
                const viewButton = document.createElement('button');
                viewButton.className = 'btn btn-info btn-sm text-xs p-1 btn-icon-only';
                viewButton.title = 'View Details';
                viewButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/></svg>`;
                viewButton.onclick = () => openEntryDetailsModal(entry.id); 
                actCell.appendChild(viewButton);
            });
            renderPaginationControls(filtered.length);
        }
        
        function getNextPlannedActionTimestamp(entry) { 
            let plannedTimestampStr = 'N/A';
            let isOverdue = false;
            const now = new Date();

            const checkAndSet = (statusToCheck, plannedKey, actualKey) => {
                if (entry.status === statusToCheck && entry[plannedKey] && entry[plannedKey] !== "SKIPPED" && (!entry[actualKey] || entry[actualKey] === "SKIPPED")) {
                    plannedTimestampStr = formatDateForDisplay(entry[plannedKey]);
                    const plannedDate = new Date(entry[plannedKey].replace(/-/g, " ").replace(" AM", "").replace(" PM", "")); 
                    if (!isNaN(plannedDate.getTime()) && plannedDate < now) {
                        isOverdue = true;
                    }
                    return true; 
                }
                return false;
            };
            
            if (entry.status === STATUS_MAP.STEP7_COMPLETE && entry.isFullPaymentReceived === true) {
                if (entry.plannedTimestamp_paymentCompletion && entry.plannedTimestamp_paymentCompletion !== "SKIPPED" && (!entry.actualTimestamp_paymentCompletion || entry.actualTimestamp_paymentCompletion === "SKIPPED")) {
                     plannedTimestampStr = formatDateForDisplay(entry.plannedTimestamp_paymentCompletion);
                     const plannedDate = new Date(entry.plannedTimestamp_paymentCompletion.replace(/-/g, " ").replace(" AM", "").replace(" PM", ""));
                     if(!isNaN(plannedDate.getTime()) && plannedDate < now) isOverdue = true;
                }
            } else {
                 if (checkAndSet(STATUS_MAP.STEP1_COMPLETE, 'plannedTimestamp_customerConfirmation', 'actualTimestamp_customerConfirmation')) {}
                else if (checkAndSet(STATUS_MAP.STEP2_COMPLETE, 'plannedTimestamp_billPreparation', 'actualTimestamp_billPreparation')) {}
                else if (checkAndSet(STATUS_MAP.STEP3_COMPLETE, 'plannedTimestamp_invoiceGeneration', 'actualTimestamp_invoiceGeneration')) {}
                else if (checkAndSet(STATUS_MAP.STEP4_COMPLETE, 'plannedTimestamp_billReceivingFollowup', 'actualTimestamp_billReceivingFollowup')) {}
                else if (checkAndSet(STATUS_MAP.STEP5_COMPLETE, 'plannedTimestamp_paymentFollowup', 'actualTimestamp_paymentFollowup')) {}
                else if (checkAndSet(STATUS_MAP.STEP6_COMPLETE, 'plannedTimestamp_paymentReceive', 'actualTimestamp_paymentReceive')) {}
                else if (checkAndSet(STATUS_MAP.STEP7_COMPLETE, 'plannedTimestamp_dueFollowup', 'actualTimestamp_dueFollowup')) {} 
                else if (checkAndSet(STATUS_MAP.STEP8_COMPLETE, 'plannedTimestamp_paymentArrangement', 'actualTimestamp_paymentArrangement')) {}
                else if (checkAndSet(STATUS_MAP.STEP9_COMPLETE, 'plannedTimestamp_paymentCompletion', 'actualTimestamp_paymentCompletion')) {}
            }
            
            return { text: plannedTimestampStr, isOverdue: isOverdue };
        }


        function renderPaginationControls(total) {
            paginationControls.innerHTML=''; const totalPages=Math.ceil(total/ITEMS_PER_PAGE); if(totalPages<=1)return;
            const p=Object.assign(document.createElement('button'),{textContent:'Previous',className:'btn btn-secondary text-sm',disabled:currentPage===1,onclick:()=>{if(currentPage>1){currentPage--; applySorting(); renderTable(allEntries);}}});
            const n=Object.assign(document.createElement('button'),{textContent:'Next',className:'btn btn-secondary text-sm',disabled:currentPage===totalPages,onclick:()=>{if(currentPage<totalPages){currentPage++; applySorting(); renderTable(allEntries);}}});
            const i=Object.assign(document.createElement('span'),{textContent:`Page ${currentPage} of ${totalPages}`,className:'px-4 py-2 text-sm text-gray-700'});
            paginationControls.append(p,i,n);
        }
        function confirmDeleteEntry(id, identifier) {
            if(!id && id !== 0){ 
                showUserAlert('Error: Entry ID missing for deletion.','error');
                return;
            }
            showUserAlert(`Are you sure you want to delete entry: "${identifier}" (ID: ${id})? This action cannot be undone.`, 
            'confirm',
            () => { 
                deleteEntry(id);
                closeAlertModal();
            });
        }
        async function deleteEntry(id) {
             if (VIEW_ENTRIES_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') { 
                console.warn("Using local demo mode for deleteEntry.");
                const entryIndex = allEntries.findIndex(e => e.id === id.toString()); 
                if (entryIndex > -1) {
                    const deletedEntryIdentifier = allEntries[entryIndex].billingName || allEntries[entryIndex].uid;
                    allEntries.splice(entryIndex, 1);
                    applySorting(); renderTable(allEntries);
                    generateAndSetNextUid(); 
                    showUserAlert(`Entry "${deletedEntryIdentifier}" deleted locally (demo).`, 'success');
                } else {
                    showUserAlert('Error: Entry not found for local deletion (demo).', 'error');
                }
                return;
            }
            tableStatus.textContent='Deleting entry...';tableStatus.classList.remove('hidden');
            try {
                const deleteUrl = `${MODIFY_ENTRIES_URL}/id/${id}`; 
                const res = await fetch(deleteUrl, { method:'DELETE' });

                if(res.ok){
                    showUserAlert('Entry deleted successfully!','success');
                    fetchEntries(); 
                } else{
                    const errorResult = await res.json().catch(() => ({ message: 'Unknown error, unable to parse response.' }));
                    showUserAlert('Error deleting entry: '+(errorResult.error || errorResult.message || res.statusText),'error');
                    tableStatus.classList.add('hidden');
                }
            }catch(e){
                console.error('Error deleting entry:',e);
                showUserAlert('Network error while deleting entry: '+e.message,'error');
                tableStatus.classList.add('hidden');
            } 
        }

        // Dashboard Header JS
        function updateDateTime() {
            const dateTimeDisplay = document.getElementById('dateTimeDisplay');
            if (dateTimeDisplay) {
                const now = new Date();
                const options = { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                };
                dateTimeDisplay.textContent = now.toLocaleString('en-US', options);
            }
        }

        const dashboardSyncButton = document.getElementById('syncButton'); 
        if (dashboardSyncButton) {
            dashboardSyncButton.addEventListener('click', () => {
                const svgIcon = dashboardSyncButton.querySelector('svg');
                if (svgIcon) {
                    svgIcon.classList.add('rotate-animate');
                    console.log("Syncing data via dashboard header button...");
                    fetchEntries(); 
                    setTimeout(() => {
                        svgIcon.classList.remove('rotate-animate');
                        console.log("Sync complete.");
                    }, 1000); 
                }
            });
        }
        
    </script>
</body>
</html>